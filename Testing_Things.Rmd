---
title: "Testing Things"
author: "Anton Holm"
date: '2020-04-08'
output: pdf_document


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
```

```{r}
library(kableExtra)
library(knitr)
library(tidyverse)
library(tinytex)
library(directlabels)


df_slope0.01_res0.05 %>% 
  group_by(Method) %>% 
  summarise(mean(Beta))

df_slope0.01_res0.05 %>% 
  ggplot(aes(x=simulation, y=Beta, color=Method)) +
  geom_line()

df_slope0.01_res0.05 %>% 
  group_by(Method, `Limit fraction`) %>% 
  summarise(mean(Intercept))



dataset_censored %>% as.data.frame() %>% 
  filter(. < 0) %>%  count()

length(dataset_censored)


df_slope0.05_res0.05 %>% 
  group_by(Method, `Limit fraction`) %>% 
  summarise(mean(Intercept))


df_slope0.05_res0.05 %>% 
  ggplot(aes(x=simulation, y= Beta, color = Method)) + 
  geom_line()


df_slope0.01_res1.4 %>% 
  group_by(Method, `Limit fraction`) %>% 
  summarise(mean(Beta))

df_slope0.05_res1.4 %>% 
  ggplot(aes(x=simulation, y=Beta, col=Method)) + geom_line()

df_slope0.01_res1.4 %>% 
  mutate(diff = abs(Beta-Slope)) %>% 
  group_by(Method, `Limit fraction`) %>% 
  summarise(min(diff))

load("s05_res05.Rda")
df_slope0.05_res0.05

https://www.youtube.com/watch?v=AnbiNaVp3eQ
https://cran.r-project.org/web/packages/lmec/lmec.pdf
https://babel.hathitrust.org/cgi/pt?id=mdp.39015059153646&view=1up&seq=6
http://nrm.diva-portal.org/smash/get/diva2:1090746/FULLTEXT01.pdf
https://tools.kib.ki.se/referensguide/apa/rapporter-rapporterielektroniskformmednamngivenforfattare
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4377318/
  https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5138145/
  https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4377318/
  
  http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.56.3943&rep=rep1&type=pdf

fitted
summary(true_model)

df_slope0.05_res0.05 %>% 
  ggplot(aes(x=simulation, y=Beta, col=Method)) + geom_line()

load("s1.01_r1.4.Rda")
load("s1.01_r0.05.Rda")
load("s1.05_r0.05.Rda")
load("s1.05_r1.4.Rda")

slope0.01_res0.05
slope0.01_res1.4
slope0.05_res0.05
slope0.05_res1.4


finished_df <- full_join(slope0.01_res0.05, slope0.01_res1.4) %>% 
  full_join(slope0.05_res0.05) %>% 
  full_join(slope0.05_res1.4)

save(finished_df, file = "finished_df.Rda")

finished_df %>% 
  mutate(diff = abs(Beta - Slope)) %>% 
  group_by(Method) %>% 
  summarise(mean(diff))


metals <- read_csv("../metals.csv")

metals %>% 
  group_by(YEAR, LOC) %>% 
  summarise(std = sd(NI)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  group_by(YEAR) %>% 
  summarise(max(std))
  
min_variances <- metals %>% 
  group_by(LOC, YEAR) %>% 
  summarise(std = sd(NI)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  group_by(YEAR) %>% 
  summarise(min_std = min(std)) %>% 
  select('min_std')

max_variances <- metals %>% 
  group_by(LOC, YEAR) %>% 
  summarise(std = sd(NI)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  group_by(YEAR) %>% 
  summarise(max_std = max(std)) %>% 
  select('max_std')

Yearly_variances <- c()

metals %>% filter(YEAR == 2015) %>% group_by(LOC) %>% count()

metals %>% group_by(LOC, YEAR) %>% summarise(sd(NI))

target_locations <- metals %>% group_by(LOC, YEAR) %>% count() %>% filter(n>9) %>% ungroup() %>% select(LOC) %>% filter(LOC != "Utlängan (spring)") %>% filter(LOC !="Ängskärsklubb (spring)") %>% filter(LOC != "Örefjärden")


locations_w_many_obs <- metals %>% filter(LOC %in% target_locations[[1]])

min_std_yearly <- locations_w_many_obs %>% group_by(LOC, YEAR) %>%  summarise(std = sd(NI)) %>% na.omit() %>% ungroup() %>% group_by(YEAR) %>% summarise(min_sd = min(std))

max_std_yearly <- locations_w_many_obs %>% group_by(LOC, YEAR) %>%  summarise(std = sd(NI)) %>% na.omit() %>% ungroup() %>% group_by(YEAR) %>% summarise(max_sd = max(std))
yearly_variances <- cbind(min_std_yearly[,2], max_std_yearly[,2])


save(yearly_variances, file="yearly_variances.Rda")



df_1.01_1.4_HIGH

df_1.05_1.4_HIGH
library(tidyverse)
NI_data <- metals %>% 
  select(NI) %>% 
  na.omit() %>% 
  filter(NI>0)
NI_data[[1]]




df_1.05_1.4_HIGH %>% ggplot(aes(x = abs(Beta), y = `Beta sd`, col = Method)) + geom_point()

df_1.05_1.4_HIGH %>% mutate(diff = abs(Beta - Slope)) %>% ggplot(aes(x=diff, y=Beta, col = Method)) + geom_point()

split_df <- df_1.05_1.4_HIGH %>% dplyr::select(simulation, Method, `Beta`) %>% spread(Method, `Beta`)

split_df %>% ggplot(aes(x=Museum, y=True)) + geom_point()

df_1.05_1.4_HIGH %>% 
  mutate(diff=abs(Beta-Slope)) %>% 
  group_by(Method) %>% 
  summarise(bias = mean(diff))

df_1.05_1.4_HIGH %>% 
  group_by(Method) %>% 
  mutate(mean_beta = mean(Beta)) %>% 
  mutate(bias = mean_beta - Slope)





#____________________________________________________

```


```{r}
load("Simulations/slope1.01_res0.05_randomHIGH.Rda")
load("Simulations/slope1.01_res0.05_randomLOW.Rda")
load("Simulations/slope1.01_res1.4_randomHIGH.Rda")
load("Simulations/slope1.01_res1.4_randomLOW.Rda")
load("Simulations/slope1.05_res0.05_randomHIGH.Rda")
load("Simulations/slope1.05_res0.05_randomLOW.Rda")
load("Simulations/slope1.05_res1.4_randomHIGH.Rda")
load("Simulations/slope1.05_res1.4_randomLOW.Rda")












Completed_df <- full_join(df_1.01_0.05_LOW,df_1.01_0.05_HIGH) %>%
  full_join(df_1.01_1.4_LOW) %>% 
  full_join(df_1.01_1.4_HIGH) %>% 
  full_join(df_1.05_0.05_LOW) %>% 
  full_join(df_1.05_0.05_HIGH) %>% 
  full_join(df_1.05_1.4_LOW) %>% 
  full_join(df_1.05_1.4_HIGH) %>% 
  mutate(CI_Lower = Beta - `Beta sd`*1.96) %>% 
  mutate(CI_Upper = Beta + `Beta sd`*1.96) %>% 
  mutate(Coverage = ifelse(Slope>CI_Lower & Slope < CI_Upper, 1, 0 ))

save(Completed_df, file = "Completed_df.Rda")

Completed_df %>% 
  mutate(diff = abs(Beta-Slope)) %>% 
  group_by(Method, Std, Slope, `Random Effects`, `Limit fraction`) %>% 
  summarise(Bias = mean(Coverage)) %>% 
  arrange(Bias)


Completed_df %>% filter(Method == "Museum")


Completed_df %>% 
  mutate(diff = abs(Beta-Slope)) %>%
  mutate(diff2 = Beta-Slope) %>% 
  group_by(Method) %>% 
  summarise(mean(diff2))

example_of_one_simulation <- cbind(kovariat, predictors, cens) %>% as.data.frame() %>% mutate(cens = as.factor(cens)) %>% mutate(cens = ifelse(cens = 0, "Uncensored", "Censored"))

save(example_of_one_simulation, file = "example_of_simulation.Rda")
example_graph <- example_of_one_simulation %>% 
  ggplot(aes(x=kovariat, y=log(predictors), shape = cens)) + 
  geom_point() +
  geom_hline(yintercept = log(1.723875), linetype = 'dashed') +
  scale_shape_manual(values = c(16,1)) +
  xlim(-5, 6) +
  theme_minimal() +
  theme(plot.caption=element_text(hjust = 0.2), legend.position = c(0.9, 0.2), legend.background = element_rect(color = "black", 
    fill = NA, size =0.5, linetype = "solid"),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5),legend.title = element_blank()) +
  labs(x='X', y = 'Log(Y)', caption= "Figure 1: Simulated data with 60% censoring, large variations and slope representing 5% yearly increase holding 
both error terms at a high variance level.") + 
  geom_text(aes(x = 6, y = 1.1), label = "LOQ", size = 3, show.legend = FALSE, family = "serif")
  

save(example_graph, file = "example_graph.Rda")


cor(kovariat, log(predictors))
```


```{r}
with_bias <- Completed_df %>% 
  filter(Method != "True") %>% 
  mutate(diff = (Beta-Slope)^2) %>% 
  group_by(`Limit fraction`, Slope, Std, `Random Effects`, Method) %>% 
  summarise(bias = mean(diff)) %>% 
  ungroup

with_coverage <- Completed_df %>% 
  filter(Method != "True") %>% 
  mutate(diff = (Beta-Slope)^2) %>% 
  group_by(`Limit fraction`, Slope, Std, `Random Effects`, Method) %>% 
  summarise(coverage = mean(Coverage))

bias_coverage <- with_bias %>% 
  mutate(Coverage = with_coverage$coverage)

save(bias_coverage, file = "bias_coverage_df.Rda")
save(Completed_df, file = "Completed_df.Rda")

load("Completed_df.Rda")
Completed_df




Variances <- Completed_df %>% 
  filter(Method != "True") %>% 
  group_by(`Limit fraction`, Slope, Std, `Random Effects`, Method) %>% 
  summarise(Variance = sd(Beta)^2)

bias_coverage




All_Summary_Stats <- bias_coverage %>% 
  inner_join(Variances, by = c('Limit fraction', 'Slope', 'Std', 'Random Effects', 'Method')) %>% 
  mutate(MSE = bias + Variance)

save(All_Summary_Stats, file = "All_Summary_Stats.Rda")


All_Summary_Stats

table_data <- Completed_df %>% 
  group_by(Method, `Limit fraction`, Std, Slope, `Random Effects`) %>% 
  mutate(count=1:n()) %>% 
  ungroup %>% 
  mutate(Method = ifelse(count==1, as.character(Method), NA)) %>% 
  filter(Method=="True")

#It's 30% Censored, Slope 1%
Summary_LOQ30_Slope1.01 <- All_Summary_Stats %>% 
  filter(`Limit fraction` == 0.3) %>% 
  filter(Slope < 0.01) %>% 
  mutate(Slope = '1%') %>%
  select(-c(`Limit fraction`, Slope)) %>% 
  group_by(Std) %>% 
  mutate(count = 1:n()) %>% 
  ungroup %>% 
  mutate(Std = ifelse(count == 1, Std, NA)) %>% 
  group_by(`Random Effects`) %>% 
  mutate(count = 1:n()) %>% 
  ungroup %>% 
  mutate(`Random Effects` = ifelse(count == 1| count == 3, `Random Effects`, NA)) %>% 
  select(-c(count, MSE )) %>% 
  mutate(bias = round(bias, digits = 4)) %>% 
  rename(Bias = bias) %>% 
  mutate(Variance = round(Variance, digits = 4))



LOQ30_Slope1.01_table <- htmlTable(Summary_LOQ30_Slope1.01, rnames=FALSE, align="llllll", align.header="cccccc",
          col.rgroup = rep(c("none", "gray93"), each=2),
          css.cell = c("padding-left: 0em","padding-left: 1em",rep("padding-left: 2em",5)))

save(LOQ30_Slope1.01_table, file = "LOQ30_Slope1.01_table.Rda")

htmlTable(Summary_LOQ30_Slope1.01, rnames=FALSE, align="llllll", align.header="cccccc",
          col.rgroup = rep(c("none", "gray93"), each=2),
          css.cell = c("padding-left: 0em","padding-left: 1em",rep("padding-left: 2em",5)))


LOQ30_Slope1.01_table <- htmlTable(Summary_LOQ30_Slope1.01, rnames=FALSE, align="llllll", align.header="cccccc",
          col.rgroup = rep(c("none", "gray93"), each=2),
          css.cell = c("padding-left: 0em","padding-left: 1em",rep("padding-left: 2em",5)),
          caption = "Table 1: Summary statistics having 30% censored observations and a yearly increase of 1% on the original scale.")

png("LOQ30_Slope1.01_table_img.png")
p<-tableGrob(LOQ30_Slope1.01_table)
grid.arrange(p)
dev.off()




Summary_LOQ30_Slope1.01


knitr::kable(Summary_LOQ30_Slope1.01, caption = "Group Rows", booktabs = T) %>%
kable_styling() %>%
pack_rows("Group 1", 4, 7, latex_gap_space = "2em") %>%
pack_rows("Group 2", 8, 10)







All_Summary_Stats


collapse_rows_dt <- data.frame(C1 = c(rep("a", 10), rep("b", 5)),
C2 = c(rep("c", 7), rep("d", 3), rep("c", 2), rep("d", 3)),
C3 = 1:15,
C4 = sample(c(0,1), 15, replace = TRUE))

ex_table <- kable(collapse_rows_dt, format = "latex", booktabs = T, align = "l") %>%
column_spec(1, bold=T) %>%
collapse_rows(columns = 1:2, latex_hline = "major", valign = "middle")

save(ex_table, file = "ex_table.Rda")


kable(iris, format = "latex")
```

```{r}
knitr::kable(iris, format = "html")


kable(collapse_rows_dt, format = "html", booktabs = T, align = "l") %>%
column_spec(1, bold=T) %>%
collapse_rows(columns = 1:2, latex_hline = "major", valign = "middle")




Summary_LOQ30_Slope1.01 <- All_Summary_Stats %>% 
  filter(`Limit fraction` == 0.3) %>% 
  filter(Slope < 0.01) %>% 
  mutate(Slope = '1%') %>%
  select(-c(`Limit fraction`, Slope))

test_table <- kable(Summary_LOQ30_Slope1.01, format = "latex", booktabs = T, align = "l") %>%
column_spec(1, bold=T) %>%
collapse_rows(columns = 1:2, latex_hline = "major", valign = "middle")

save(test_table, file = "test_table.Rda")






epsilon_errors123 <- rlnorm(N, mean, sd[2]) #Get the error terms for each response variable
    year1 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[1,2]) #Simulates between-years errorterms
    year2 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[2,2])
    year3 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[3,2])
    year4 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[4,2])
    year5 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[5,2])
    year6 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[6,2])
    year7 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[7,2])
    year8 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[8,2])
    year9 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[9,2])
    year10 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[10,2])
    year11 <- rlnorm(N/nr_of_covariates, mean, yearly_variances[11,2])
    random_effects123 <- c(year1, year2, year3, year4, year5, year6, year7, year8, year9, year10, year11)
    n <- length(epsilon_errors123) #Number of error terms noted as n
    LOQ <- sort(epsilon_errors123*random_effects123)[0.6*n] #Decides the LOQ for the specific repitition
    predictors123 <- exp(kovariat*slope[2]) * epsilon_errors123*random_effects123 #Intercept = 0, Slope = selected value of slope vector,  this builds our model to simulate from
    dataset_censored123 <- ifelse(predictors123<LOQ, -LOQ, predictors123) #Censores values under LOQ
    
    
dataset_censored123 %>% as.data.frame() %>% filter(. < 0) %>% count()    

80/length(dataset_censored123)


betas_LOQ0.3_Slope1.05_LL <- Completed_df %>%
  filter(`Limit fraction` == 0.3) %>% 
  filter(Slope > 0.01) %>% 
  filter(Std == 0.05) %>% 
  filter(Method != 'True') %>% 
  filter(`Random Effects` == "Low") %>% 
  select(simulation, Method, Beta) %>% 
  spread(Method, Beta)

betas_LOQ0.6_Slope1.05_LL <- Completed_df %>%
  filter(`Limit fraction` == 0.6) %>% 
  filter(Slope > 0.01) %>% 
  filter(Std == 0.05) %>% 
  filter(Method != 'True') %>% 
  filter(`Random Effects` == "Low") %>% 
  select(simulation, Method, Beta) %>% 
  spread(Method, Beta)

betas_LOQ0.3_Slope1.01_LL <- Completed_df %>%
  filter(`Limit fraction` == 0.3) %>% 
  filter(Slope < 0.01) %>% 
  filter(Std == 0.05) %>% 
  filter(Method != 'True') %>% 
  filter(`Random Effects` == "Low") %>% 
  select(simulation, Method, Beta) %>% 
  spread(Method, Beta)

betas_LOQ0.6_Slope1.01_LL <- Completed_df %>%
  filter(`Limit fraction` == 0.6) %>% 
  filter(Slope < 0.01) %>% 
  filter(Std == 0.05) %>% 
  filter(Method != 'True') %>% 
  filter(`Random Effects` == "Low") %>% 
  select(simulation, Method, Beta) %>% 
  spread(Method, Beta)

plot_betas %>% 
  ggplot(aes(x=Museum, y=Tobit)) +
  geom_point()

save(Completed_df, file = "Completed_df.Rda")
Completed_df_fixed <- Completed_df %>% mutate(`Random Effects` = replace(`Random Effects`, `Random Effects` == "HIGH", "High"))
betas <- Completed_df %>% filter(Method != "True")


tobit_betas_low <- betas %>% 
  filter(Method == "Tobit") %>% 
  select(-(Method)) %>% 
  filter(Std == 0.05) %>% 
  filter(`Random Effects` == "Low")


museum_betas_low <- betas %>% 
  filter(Method == "Museum") %>% 
  select(-(Method)) %>% 
  filter(Std == 0.05) %>% 
  filter(`Random Effects` == "Low")

betas_spread_low <- inner_join(tobit_betas_low, museum_betas_low, by = c("simulation", "Limit fraction", "Slope", "Std", "Random Effects"))


betas_spread_low %>% ggplot(aes(x=Beta.x, y=Beta.y)) + geom_point() + facet_grid(`Limit fraction` ~ Slope)



tobit_betas_high <- betas %>% 
  filter(Method == "Tobit") %>% 
  select(-(Method)) %>% 
  filter(Std == 1.4) %>% 
  filter(`Random Effects` == "High") %>% 
  mutate(Beta = Beta/Slope)


museum_betas_high <- betas %>% 
  filter(Method == "Museum") %>% 
  select(-(Method)) %>% 
  filter(Std == 1.4) %>% 
  filter(`Random Effects` == "High") %>% 
  mutate(Beta = Beta/Slope)

betas_spread_high <- inner_join(tobit_betas_high, museum_betas_high, by = c("simulation", "Limit fraction", "Slope", "Std", "Random Effects"))


betas_spread_high %>% ggplot(aes(x=Beta.x, y=Beta.y)) + geom_point() + facet_grid(`Limit fraction` ~ Slope)

Completed_df %>% 
  filter(`Random Effects` == "HIGH")
```












