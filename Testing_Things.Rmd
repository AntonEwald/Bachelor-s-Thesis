---
title: "Testing Things"
author: "Anton Holm"
date: '2020-04-08'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
```

```{r}
library(fitdistrplus)
library(kableExtra)
library(reshape2)
library(htmlTable)

df_slope0.01_res0.05 %>% 
  group_by(Method) %>% 
  summarise(mean(Beta))

df_slope0.01_res0.05 %>% 
  ggplot(aes(x=simulation, y=Beta, color=Method)) +
  geom_line()

df_slope0.01_res0.05 %>% 
  group_by(Method, `Limit fraction`) %>% 
  summarise(mean(Intercept))



dataset_censored %>% as.data.frame() %>% 
  filter(. < 0) %>%  count()

length(dataset_censored)


df_slope0.05_res0.05 %>% 
  group_by(Method, `Limit fraction`) %>% 
  summarise(mean(Intercept))


df_slope0.05_res0.05 %>% 
  ggplot(aes(x=simulation, y= Beta, color = Method)) + 
  geom_line()


df_slope0.01_res1.4 %>% 
  group_by(Method, `Limit fraction`) %>% 
  summarise(mean(Beta))

df_slope0.05_res1.4 %>% 
  ggplot(aes(x=simulation, y=Beta, col=Method)) + geom_line()

df_slope0.01_res1.4 %>% 
  mutate(diff = abs(Beta-Slope)) %>% 
  group_by(Method, `Limit fraction`) %>% 
  summarise(min(diff))

load("s05_res05.Rda")
df_slope0.05_res0.05

https://www.youtube.com/watch?v=AnbiNaVp3eQ
https://cran.r-project.org/web/packages/lmec/lmec.pdf
https://babel.hathitrust.org/cgi/pt?id=mdp.39015059153646&view=1up&seq=6
http://nrm.diva-portal.org/smash/get/diva2:1090746/FULLTEXT01.pdf
https://tools.kib.ki.se/referensguide/apa/rapporter-rapporterielektroniskformmednamngivenforfattare
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4377318/
  https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5138145/
  https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4377318/
  
  http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.56.3943&rep=rep1&type=pdf

fitted
summary(true_model)

df_slope0.05_res0.05 %>% 
  ggplot(aes(x=simulation, y=Beta, col=Method)) + geom_line()

load("s1.01_r1.4.Rda")
load("s1.01_r0.05.Rda")
load("s1.05_r0.05.Rda")
load("s1.05_r1.4.Rda")

slope0.01_res0.05
slope0.01_res1.4
slope0.05_res0.05
slope0.05_res1.4


finished_df <- full_join(slope0.01_res0.05, slope0.01_res1.4) %>% 
  full_join(slope0.05_res0.05) %>% 
  full_join(slope0.05_res1.4)

save(finished_df, file = "finished_df.Rda")

finished_df %>% 
  mutate(diff = abs(Beta - Slope)) %>% 
  group_by(Method) %>% 
  summarise(mean(diff))


metals <- read_csv("../metals.csv")

metals %>% 
  group_by(YEAR, LOC) %>% 
  summarise(std = sd(NI)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  group_by(YEAR) %>% 
  summarise(max(std))
  
min_variances <- metals %>% 
  group_by(LOC, YEAR) %>% 
  summarise(std = sd(NI)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  group_by(YEAR) %>% 
  summarise(min_std = min(std)) %>% 
  select('min_std')

max_variances <- metals %>% 
  group_by(LOC, YEAR) %>% 
  summarise(std = sd(NI)) %>% 
  ungroup() %>% 
  na.omit() %>% 
  group_by(YEAR) %>% 
  summarise(max_std = max(std)) %>% 
  select('max_std')

Yearly_variances <- c()

metals %>% filter(YEAR == 2015) %>% group_by(LOC) %>% count()

metals %>% group_by(LOC, YEAR) %>% summarise(sd(NI))

target_locations <- metals %>% group_by(LOC, YEAR) %>% count() %>% filter(n>9) %>% ungroup() %>% select(LOC) %>% filter(LOC != "Utlängan (spring)") %>% filter(LOC !="Ängskärsklubb (spring)") %>% filter(LOC != "Örefjärden")


locations_w_many_obs <- metals %>% filter(LOC %in% target_locations[[1]])

min_std_yearly <- locations_w_many_obs %>% group_by(LOC, YEAR) %>%  summarise(std = sd(NI)) %>% na.omit() %>% ungroup() %>% group_by(YEAR) %>% summarise(min_sd = min(std))

max_std_yearly <- locations_w_many_obs %>% group_by(LOC, YEAR) %>%  summarise(std = sd(NI)) %>% na.omit() %>% ungroup() %>% group_by(YEAR) %>% summarise(max_sd = max(std))
yearly_variances <- cbind(min_std_yearly[,2], max_std_yearly[,2])


save(yearly_variances, file="yearly_variances.Rda")



df_1.01_1.4_HIGH

df_1.05_1.4_HIGH
library(tidyverse)
NI_data <- metals %>% 
  select(NI) %>% 
  na.omit() %>% 
  filter(NI>0)
NI_data[[1]]




df_1.05_1.4_HIGH %>% ggplot(aes(x = abs(Beta), y = `Beta sd`, col = Method)) + geom_point()

df_1.05_1.4_HIGH %>% mutate(diff = abs(Beta - Slope)) %>% ggplot(aes(x=diff, y=Beta, col = Method)) + geom_point()

split_df <- df_1.05_1.4_HIGH %>% dplyr::select(simulation, Method, `Beta`) %>% spread(Method, `Beta`)

split_df %>% ggplot(aes(x=Museum, y=True)) + geom_point()

df_1.05_1.4_HIGH %>% 
  mutate(diff=abs(Beta-Slope)) %>% 
  group_by(Method) %>% 
  summarise(bias = mean(diff))

df_1.05_1.4_HIGH %>% 
  group_by(Method) %>% 
  mutate(mean_beta = mean(Beta)) %>% 
  mutate(bias = mean_beta - Slope)





#____________________________________________________

```


```{r}
load("Simulations/slope1.01_res0.05_randomHIGH.Rda")
load("Simulations/slope1.01_res0.05_randomLOW.Rda")
load("Simulations/slope1.01_res1.4_randomHIGH.Rda")
load("Simulations/slope1.01_res1.4_randomLOW.Rda")
load("Simulations/slope1.05_res0.05_randomHIGH.Rda")
load("Simulations/slope1.05_res0.05_randomLOW.Rda")
load("Simulations/slope1.05_res1.4_randomHIGH.Rda")
load("Simulations/slope1.05_res1.4_randomLOW.Rda")












Completed_df <- full_join(df_1.01_0.05_LOW,df_1.01_0.05_HIGH) %>%
  full_join(df_1.01_1.4_LOW) %>% 
  full_join(df_1.01_1.4_HIGH) %>% 
  full_join(df_1.05_0.05_LOW) %>% 
  full_join(df_1.05_0.05_HIGH) %>% 
  full_join(df_1.05_1.4_LOW) %>% 
  full_join(df_1.05_1.4_HIGH) %>% 
  mutate(CI_Lower = Beta - `Beta sd`*1.96) %>% 
  mutate(CI_Upper = Beta + `Beta sd`*1.96) %>% 
  mutate(Coverage = ifelse(Slope>CI_Lower & Slope < CI_Upper, 1, 0 ))


Completed_df %>% 
  mutate(diff = abs(Beta-Slope)) %>% 
  group_by(Method, Std, Slope, `Random Effects`, `Limit fraction`) %>% 
  summarise(Bias = mean(Coverage)) %>% 
  arrange(Bias)


Completed_df %>% filter(Method == "Museum")


Completed_df %>% 
  mutate(diff = abs(Beta-Slope)) %>%
  mutate(diff2 = Beta-Slope) %>% 
  group_by(Method) %>% 
  summarise(mean(diff2))

example_of_one_simulation <- cbind(kovariat, predictors, cens) %>% as.data.frame() %>% mutate(cens = as.factor(cens))

save(example_of_one_simulation, file = "example_of_simulation.Rda")
example_graph <- example_of_one_simulation %>% ggplot(aes(x=kovariat, y=log(predictors), shape = cens)) + geom_point() +
  scale_shape_manual(values = c(16,1)) +
  theme_minimal() +
  theme(plot.caption=element_text(hjust = 0.2),
        panel.border = element_rect(colour = "black", fill=NA, size=0.5)) +
  labs(x='X', y = 'Log(Y)', caption= "Figure 1: Simulated data with 60% censoring, large variations and slope representing 5% yearly increase.")
  

save(example_graph, file = "example_graph.Rda")







st = iris %>% 
  gather(measure, value, -Species) %>% 
  separate(measure, into=c("attribute", "dimension")) %>% 
  group_by(Species, attribute, dimension) %>% 
  summarise(mean=mean(value)) %>%
  spread(dimension, mean) 

st = st %>%
  group_by(Species) %>%
  mutate(count=1:n()) %>%
  ungroup %>%
  mutate(Species = ifelse(count==1, as.character(Species), NA)) %>%
  dplyr::select(-count)


st[,sapply(st,is.numeric)] = sapply(st[,sapply(st,is.numeric)], function(x) sprintf("%1.2f",x))





table_data <- Completed_df %>% 
  group_by(Method, `Limit fraction`, Std, Slope, `Random Effects`) %>% 
  mutate(count=1:n()) %>% 
  ungroup %>% 
  mutate(Method = ifelse(count==1, as.character(Method), NA)) %>% 
  filter(Method=="True")


htmlTable(table_data, rnames=FALSE, align="llrr", align.header="llrr",
          col.rgroup = rep(c("none", "gray93"), each=2),
          css.cell = c("padding-left: 0em","padding-left: 1em",rep("padding-left: 2em",12)))


LOQ30_Slope1.01 <- Completed_df %>% 
  filter(`Limit fraction` == 0.3) %>% 
  filter(Slope <0.01) %>% 
  mutate(Slope = "1%")


with_bias <- Completed_df %>% 
  filter(Method != "True") %>% 
  mutate(diff = abs(Beta-Slope)) %>% 
  group_by(`Limit fraction`, Slope, Std, Method, `Random Effects`) %>% 
  summarise(bias = mean(diff)) %>% 
  ungroup

with_bias2 <- Completed_df %>% 
  filter(Method != "True") %>% 
  mutate(diff = (Beta-Slope)^2) %>% 
  group_by(`Limit fraction`, Slope, Std, Method, `Random Effects`) %>% 
  summarise(bias = mean(diff)) %>% 
  ungroup

with_bias3 <- Completed_df %>% 
  filter(Method != "True") %>% 
  mutate(diff = (Beta-Slope)) %>% 
  group_by(`Limit fraction`, Slope, Std, Method, `Random Effects`) %>% 
  summarise(bias = mean(diff)) %>% 
  ungroup

with_coverage <- Completed_df %>% 
  filter(Method != "True") %>% 
  mutate(diff = (Beta-Slope)^2) %>% 
  group_by(`Limit fraction`, Slope, Std, Method, `Random Effects`) %>% 
  summarise(coverage = mean(Coverage))

bias_coverage <- with_bias %>% 
  mutate('Bias Squared' = with_bias2$bias) %>% 
  mutate('Normal Bias' = with_bias3$bias) %>% 
  mutate(Coverage = with_coverage$coverage) %>% 
  rename('Abs of Bias' = bias)

save(bias_coverage, file = "bias_coverage_df.Rda")
save(Completed_df, file = "Completed_df.Rda")
```












